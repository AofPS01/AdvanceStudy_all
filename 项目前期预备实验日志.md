# 预备实验日志撰写

    胡斯涵 husihan23@mails.ucas.ac.cn
[上行这种视觉效果使用的是\[tab\]键，即缩进。本行可以视为注释，即声明变量]: #

## 目录

- [目录](#目录)
- [前言](#前言)
- [预备实验1](#预备实验1)
- [预备实验2](#预备实验2)
- [预备实验3](#预备实验3)

## 前言

&nbsp;&nbsp;&nbsp;&nbsp;我们首先了解了所要实现的目标：不再使用外接网卡来转接数据，而是使用 RJ45 网口，经过板载 PHY 芯片处理，将数据直接传给 FPGA 中运行的香山架构。实现内容主要是协议的转换和总线的连接。
&nbsp;&nbsp;&nbsp;&nbsp;看起来项目应该较为简单，但是我们缺乏相关的知识以及参与工程的经验。虽然经过了一学期 verilog 代码的编写，但是我们对于软件 Vivado 的使用仍一窍不通。因此我们和老师商议，决定先行开展预备实验，以尽早熟悉相关环境、了解相关知识。

## 预备实验1

&nbsp;&nbsp;&nbsp;&nbsp;预备实验1的实验目标是：熟悉 Vivado 软件必要的相关操作，学会使用其进行电路设计；能够根据电路板原理图添加相关约束文件；学会 AXI 总线相关连线，会使用工具对 GPIO 进行寄存器读写（即点灯实验）。实验方法是通过 PCIe 总线访问 AXI 总线上的 GPIO 寄存器。
&nbsp;&nbsp;&nbsp;&nbsp;实验一开始就不怎么顺利。再见 Vivado，我还是不怎么会使用。之前我只是将其当做编辑器和仿真工具来使用的，如今需要使用电路图设计工具、综合工具和实现工具。这些问题后来随着熟练度的提高渐渐消失，随之而来的是上板测试的超级折磨，后面将会提及。
&nbsp;&nbsp;&nbsp;&nbsp;老师给出了他实现的电路图。由于需要实现通过 PCIe 接口访问 AXI 协议下的设备，需要使用能够进行协议转换的 IP 核，即 `xdma` IP。创建好端口，设置好设备的地址，连接好相关接线，电路就算是设计完毕了。
&nbsp;&nbsp;&nbsp;&nbsp;通过 Vivado 生成 bit 流文件之后，我将其传至服务器。由于实验内容方法的特殊性，需要通过重启服务器重新枚举 PCIe 设备以确定编号。同时，为了能够使用 `xdma` 模块的功能，需要向内核中加载 `xdma.ko` 这个模块。麻烦来了：执行完加载的命令后，服务器就宕机了。无论怎么做，服务器都没有响应。之后无论我怎么修改工程，一上板测试都是一样的结果。
&nbsp;&nbsp;&nbsp;&nbsp;考虑到是加载了 `xdma.ko` 这个模块才出现的宕机，老师把他的 `xdma` 模块发给我让我使用。又经历了一番调整和漫长的等待，终于加载内核后不再宕机。
&nbsp;&nbsp;&nbsp;&nbsp;之后自然是使用工具对 GPIO 进行读写。读命令执行，结果正常，但是当我执行写命令后，再次执行读命令读取相同的寄存器时，发现结果无变化。我疑惑不解，反复测试都是如此。询问老师，老师让我去查阅该 GPIO 的手册。经过查阅，我发现 GPIO 寄存器的读写状态由它的三态寄存器控制。对三态寄存器进行操作，发现能够正常读写。修改寄存器状态为读状态，再次对数据寄存器进行读，结果正常。之后我又去查看板卡亮灯状态，完美符合终端的显示。预备实验1完美成功。

## 预备实验2

&nbsp;&nbsp;&nbsp;&nbsp;实验1成功后，我又按照老师的要求改进实验，增加 ila(Integrated Logic Analyzer) IP 核以供调试使用。经过一番尝试，我了解了 ila 的使用及连线，并成功通过 ila 模块读取到了 GPIO 寄存器的数据。预备实验2很快地顺利完成了。

## 预备实验3

&nbsp;&nbsp;&nbsp;&nbsp;在上两个实验完成后，老师又布置了新的实验——实现多时钟域下，对同一总线不同地址的外设访问。具体落到电路上，就是写两个时钟，并分出总线，连接到两个 GPIO 上。
&nbsp;&nbsp;&nbsp;&nbsp;乍一看实验也是很简单，只需在原有的实验基础上进行时钟的调整，并分出总线即可。然而问题就出在分出总线这一步。我设计完工程上板测试时，发现读写都无法正常进行，于是不断缩减设计结构后再上板测试，最终本人确定是分出总线上出了问题，认为原因出在 AXI Interconnect 这个 IP 核上。
&nbsp;&nbsp;&nbsp;&nbsp;转机发生在我在工程中添加 ila 来分析总线数据。通过 ila，我发现总线上传递的数据中，信号 `rresp` 的值为 `DECERR`，意即解码错误（decode error）。于网络上查询相关信息，我了解到这是 AXI Interconnect 未能发现从设备，即从设备实际地址与我们编写的地址不相同，进而导致访问错误。同时我观察 ila 中 AXI 协议的 AR 部分，发现地址均为`1`开头，与我通过 Address Editor 为 GPIO 所赋的地址值（全`0`）不一致。
&nbsp;&nbsp;&nbsp;&nbsp;这个`1`从何而来呢？我再次查看 IP 的编写，发现可能是 `xdma` IP 核的原因。它在实现 PCIe 转 AXI 的过程中，需要一个转换地址，这个地址在老师发过来的模块中被设置为了 `0x1000_0000`，这便是作为地址，其高位`1`的出现原因。
&nbsp;&nbsp;&nbsp;&nbsp;找到原因后，我对两个 GPIO 从设备的地址进行了修改，也将其设置为高位为`1`，再次上板测试，一切正常，可喜可贺，预备实验3也圆满成功。
