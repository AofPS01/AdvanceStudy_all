# Logs

## 7.30

### 工作内容

- 完善了前期预备实验的日志
- 了解新实验内容及目标——通过 pcie 访问 PHY 芯片内的寄存器
- 依照电路板原理图和相关 IP 手册初步设计实验电路图

### 工作时间（不含休息时间）

`8h`

---

## 7.31

### 工作内容

- 完善相关设计
- 阅读手册编写 xdc 约束文件
- 运行综合和实现

### 工作时间

`7h`

### 残留问题

实现步骤时，报错显示接口未连接完全。

---

## 8.1

### 工作内容

- 尝试连接接口，阅读相关资料无果。

### 工作时间

`7h`

---

## 8.18

### 工作内容

结束了给自己放的休假，回来向同学了解上周所做的成果：已经实现了 IP 核的搭建，并且能够读写 IP 核内的寄存器，于是着手复现（nv19pmdio）。

遇到了一些 bug ：IP 核频率的匹配上需要依照手册，lvds 直接连接 phy 出来的两个 625MHz 信号即可。

最终成功搭建。

依照手册信息着手测试与 phy 芯片之间的通信。

我上网寻找了一些mdio接口的相关知识，了解到我需要通过设置 Ethernet IP 核中寄存器的值来手动模拟向 phy 发送的 mdio 读/写帧。

写帧很好实现：`500 : 0000007E`  `508 : 00001145`  `504 : 00004800`

得到的结果是：`500 : 0000007E`  `508 : 00001145`  `504 : 00004080`

但是问题出现了！！！我发送读命令 `sudo ./proto/pcie_util /dev/xdma0_user read 0x0000050C` 时，出现了 `0x00017fff`！这和我输入的数 `1145` 不一样，我开始查错。

我阅读手册并且求助于 AI，发现我之前的一些操作也有问题：根据 phy 芯片厂家的手册，它的 MDC 频率最高为 `25MHz`，因此，`MDIO Setup Word (0x500)`可以设置为 `2`，此时 `MDC` 为 `100MHz/(1+2*2)=20MHz`。我将 `0x500` 设置为 `0x00000042`。

通过 AI 给我的回复，我推测具体的错误原因可能是 PHY 芯片地址不正确。于是我打算使用遍历的方法来找到正确的地址。我写了一个脚本`(always_read.sh)`来时刻观察 `0x50C` 寄存器的值，看是否为 `1140`。最终确定 PHY 芯片地址为 `3`，读取命令为 `sudo ./proto/pcie_util /dev/xdma0_user write 0x00000504 0x03008800`

### 工作时间

`9h`

---

## 8.19

### 工作内容

- 确切的验证了对phy芯片的读写功能
  + 具体表现为对 `0xD` 寄存器修改了最高一位并成功读取
- phy 芯片的状态寄存器 `0x1` 的链接状态能够通过网线连接进行改变，具体表现为读取的数据从`0x7949`变为`0x796D`(应该没记错)
- 通过 ila 读取了 IP 核所发送的 mdio 帧，并与发送原理做到了对应(读数据为`0x7949`)

### 残留问题

- 对 `RJ45_SGMII_SEL` 进行引脚约束 `(C38)` 后，bit 流未能正常工作。

### 待办事项

1. 计划将工作集成在 shell 上
2. 搞明白 ethernet dma 的数据传输，为连接到总线做准备
3. 阅读之前连接网卡时的 `Verilog` 代码，了解接线
4. 解决残留问题

### 工作时间

`7h`

---

## 8.22

bug 依旧存在，无法解决，经过多次的版本测试，暂时怀疑是版本问题，下周到所实践一下

---

## 8.25

经测试，在 2020.2 版本下编辑的工程所生成的 bit 流能够正常上板运行、读写数据。

---

## 8.26

今天对 `xiangshan.tcl` 和 `top.xdc` 文件进行了本地 git 编辑，进行了元件的增加和线路的连接，增加了相关引脚和时钟的约束。上服务器运行编译脚本。

---

## 8.27

发现远程断开连接，不知道具体结果。到所重启进程。

---

## 8.28

早上发现 bit 流已经生成完毕。
